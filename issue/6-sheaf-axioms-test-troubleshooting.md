# Issue #6: `test_sheaf_axioms.py` のトラブルシューティングと解決

このドキュメントは、`tests/test_sheaf_axioms.py` のテスト失敗を解決するために行ったトラブルシューティングの手順を記録したものです。

## 1. 初期状態と問題の特定

当初、`test_sheaf_axioms.py` は、主に2つの問題により失敗していました。

1.  **`KeyError: 'dominant_hue_of_shapes'`**: テストに必要な「意味次元」が読み込まれていない。
2.  **`AssertionError` (青色検出の失敗)**: 青色のオブジェクトを赤色として誤検出してしまう。

`issue_6_test_summary.md`には、後者の原因がテスト画像内でオブジェクトが重なっていることにあると記載されていましたが、調査の結果、より根深い問題が画像エンジンにあることが判明しました。

## 2. トラブルシューティングと解決の過程

テストを成功させるために、以下の修正を段階的に行いました。

### ステップ1: 意味次元の読み込みエラー (`KeyError`) の解決

- **原因**: `DimensionLoader` が、テストで必要となる `'dominant_hue_of_shapes'` 次元を定義した `vector_dimensions_custom_ai_integrated.json` をデフォルトで読み込んでいませんでした。
- **対処**: `src/dimension_loader.py` を修正し、デフォルトで読み込む次元定義ファイルのリストに `vector_dimensions_custom_ai_integrated.json` を追加しました。

### ステップ2: 色検出の失敗 (`AssertionError`) の解決

`KeyError`の修正後にテストを再実行したところ、青色のオブジェクトの色相が赤(0.0)として誤検出される`AssertionError`が発生しました。これは、`troubleshooting.md`の「エラー5」に該当します。以下の2段階で対処しました。

1.  **テストケースの単純化**:
    - **原因**: 当初のテストは、重なり合うオブジェクトを扱っており、問題の切り分けが困難でした。
    - **対処**: `tests/test_sheaf_axioms.py` を修正し、重ならない2つの四角形（赤と青）を別々に評価するようにテスト内容を変更しました。これにより、色検出ロジックそのものを独立して検証できるようになりました。

2.  **画像エンジン(`engine_opencv_legacy.py`)の修正**:
    - **原因**: テストケースを単純化しても色検出が失敗したため、問題が画像エンジンにあることが確定しました。調査の結果、輪郭検出ロジックが輝度(Lチャンネル)のみに依存しており、色の違いを分離できていないことが判明しました。
    - **対処**: `sigma_image_engines/engine_opencv_legacy.py` の輪郭検出ロジックを、輝度(Lチャンネル)と**彩度(Sチャンネル)**の両方を利用する方式に変更しました。これにより、背景から色のついた領域を正確に切り出し、正しい色相を検出できるようになりました。

## 3. 最終的な状態

上記すべての修正を経て、`tests/test_color_detection_consistency` (旧 `test_gluing_semantic_consistency`) は正常に成功することが期待されます。これにより、Issue #6に記載された問題は解決されたことになります。